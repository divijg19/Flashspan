name: AppImage

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  appimage:
    name: Build Linux AppImage (Ubuntu 22.04)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------
      # Build AppImage in Ubuntu 22.04 (CI-safe, no FUSE)
      # --------------------------------------------------
      - name: Build AppImage (Docker, Ubuntu 22.04)
        run: |
          docker run --rm \
            -v "$PWD:/workspace" \
            -w /workspace \
            ubuntu:22.04 \
            bash -c '
              set -euxo pipefail

              # Force AppImages to run without FUSE (critical for CI)
              export APPIMAGE_EXTRACT_AND_RUN=1

              echo "=== Installing system dependencies ==="
              apt-get update
              DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
                curl \
                ca-certificates \
                build-essential \
                pkg-config \
                git \
                unzip \
                file \
                xz-utils \
                patchelf \
                zsync \
                python3 \
                python3-pip \
                \
                # --- GTK / WebKit stack ---
                libgtk-3-dev \
                libwebkit2gtk-4.1-dev \
                libayatana-appindicator3-dev \
                libsecret-1-dev \
                libasound2-dev \
                libdbus-1-dev \
                libssl-dev \
                \
                # --- CRITICAL for AppImage icon handling ---
                libglib2.0-dev \
                librsvg2-dev

              echo "=== Installing Bun ==="
              export BUN_INSTALL="$HOME/.bun"
              curl -fsSL https://bun.sh/install | bash
              export PATH="$BUN_INSTALL/bin:$PATH"

              echo "=== Installing Rust ==="
              curl https://sh.rustup.rs -sSf | sh -s -- -y
              source "$HOME/.cargo/env"
              rustup default stable
              rustup target add x86_64-unknown-linux-gnu

              echo "=== Building frontend ==="
              bun install --frozen-lockfile
              bun run build

              echo "=== Building AppImage via Tauri ==="
              cd src-tauri
              bunx @tauri-apps/cli@2.9.5 build --bundles appimage --verbose
            '

      # --------------------------------------------------
      # Upload AppImage to GitHub Release
      # --------------------------------------------------
      - name: Upload AppImage to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            src-tauri/target/release/bundle/appimage/*.AppImage
